(()=>{"use strict";const e=window.wc.blocksCheckout,t=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"postcode-eu-address-validation/shipping-address-autocomplete-intl","version":"1.0.0","title":"International Address Autocomplete","category":"woocommerce","description":"Autocomplete international addresses using the Postcode.eu API.","example":{},"parent":["woocommerce/checkout-shipping-address-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"textdomain":"postcode-eu-address-validation"}'),s=window.React,r=window.wp.data,o=window.wp.element,n=window.wc.wcBlocksData,a=window.wc.wcSettings,d=window.wp.i18n,c=window.wc.blocksComponents;var i,l;const u=(0,a.getSetting)("postcode-eu-address-validation_data"),p=(e,t,s)=>{let r=t,o=s;return u.reverseStreetLineCountries.includes(e)&&([r,o]=[o,r]),`${r} ${o}`.trim()};null!==(l=(i=PostcodeNl).addressDetailsCache)&&void 0!==l||(i.addressDetailsCache=new Map);const m=({id:e,addressType:t,address:a,setAddress:i,setAddressDetails:l})=>{const m=(0,o.useRef)(null),E=(0,o.useRef)(a),h=(0,o.useRef)(""),f=(0,o.useRef)(null),[g,_]=(0,o.useState)(!0),[v,w]=(0,o.useState)(null),[A,y]=(0,o.useState)(!1),[C,S]=(0,o.useState)(""),{setValidationErrors:D,clearValidationError:I}=(0,r.useDispatch)(n.VALIDATION_STORE_KEY),{validationError:b,validationErrorId:k}=(0,r.useSelect)((t=>{const s=t(n.VALIDATION_STORE_KEY);return{validationError:s.getValidationError(e),validationErrorId:s.getValidationErrorId(e)}}));(0,o.useEffect)((()=>{E.current=a}),[a]);const T=(0,o.useCallback)((()=>{i({...E.current,address_1:"",city:"",postcode:""}),l(null)}),[i,l]),R=(0,o.useRef)(T),O=(0,o.useCallback)(((s=!0)=>{["address_1","city","postcode"].every((e=>void 0===(0,r.select)(n.VALIDATION_STORE_KEY).getValidationError(`${t}_${e}`)))?I(e):D({[e]:{message:(0,d.__)("Please enter an address and select it.","postcode-eu-address-validation"),hidden:s}})}),[e,I,D]),L=(0,o.useCallback)(((e,t)=>{PostcodeNl.addressDetailsCache.has(e)?t(PostcodeNl.addressDetailsCache.get(e)):f.current.getDetails(e,(s=>{t(s),PostcodeNl.addressDetailsCache.set(e,s)}))}),[]),N=(0,o.useCallback)((e=>{w(!0),L(e.context,(e=>{const{locality:t,street:s,postcode:r,building:o}=e.address;i({...E.current,address_1:p(e.country.iso2Code,s,o),city:t,postcode:r}),l(e),O(!1),w(!1)}))}),[w,i,l,O]),V=(0,o.useCallback)((()=>{m.current.addEventListener("autocomplete-response",(e=>{const t=e.detail.matches;1===t.length&&"Address"===t[0].precision?N(t[0]):O(!0)}),{once:!0}),f.current.search(m.current,{term:h.current,showMenu:!1})}),[N,O]);(0,o.useEffect)((()=>{g&&(_(!1),h.current=["postcode","city","address_1","address_2"].map((e=>E.current[e])).join(" ").trim(),S(h.current),m.current.addEventListener("autocomplete-select",(e=>{S(e.detail.value),e.preventDefault(),"Address"===e.detail.precision&&N(e.detail)})),m.current.addEventListener("autocomplete-search",T),m.current.addEventListener("autocomplete-error",(()=>{w(!1),D({[e]:{message:(0,d.__)("An error has occurred while retrieving address data. Please contact us if the problem persists.","postcode-eu-address-validation"),hidden:!1}})})),m.current.addEventListener("autocomplete-open",(()=>y(!0))),m.current.addEventListener("autocomplete-close",(()=>y(!1))))}),[g,_,S,l,T,w,D,y]),(0,o.useEffect)((()=>{var t,s;if(s=a.country,void 0===u.enabledCountries[s])return void I(e);const o=u.enabledCountries[a.country];null===f.current?(f.current=function(e,t){const s=new PostcodeNl.AutocompleteAddress(e,{autocompleteUrl:u.autocomplete,addressDetailsUrl:u.getDetails,context:t});return s.getSuggestions=function(e,t,s){const r=(new TextEncoder).encode(t),o=Array.from(r,(e=>String.fromCodePoint(e))).join(""),n=this.options.autocompleteUrl.replace("${context}",encodeURIComponent(e)).replace("${term}",encodeURIComponent(btoa(o)));return this.xhrGet(`${n}`,s)},s.getDetails=function(e,t){const s=this.options.addressDetailsUrl.replace("${context}",encodeURIComponent(e));return this.xhrGet(s,t)},s}(m.current,o.iso3),h.current.length>0&&V()):(f.current.reset(),f.current.setCountry(o.iso3),R.current(),S(""));const d=(0,r.select)(n.VALIDATION_STORE_KEY).getValidationError(e);O(null===(t=d?.hidden)||void 0===t||t)}),[a.country,e,I,S]),(0,o.useEffect)((()=>()=>I(e)),[I,e]),(0,o.useEffect)((()=>{null!==v&&m.current.classList.toggle(`${f.current.options.cssPrefix}loading`,v)}),[v]);const $=b?.message&&!b?.hidden;return(0,s.createElement)(c.TextInput,{id:e,required:!0,className:{"has-error":$},ref:m,label:(0,d.__)("Start typing your address or zip/postal code","postcode-eu-address-validation"),value:C,onChange:e=>{O(!0),S(e)},onBlur:()=>!A&&O(!1),"aria-invalid":!0===$,ariaDescribedBy:$&&k?k:null,feedback:(0,s.createElement)(c.ValidationInputError,{propertyName:e,elementId:e}),title:""})},E=({forId:e,onClick:t})=>{const o=(0,r.useSelect)((t=>t(n.VALIDATION_STORE_KEY).getValidationError(e))),{clearValidationError:a}=(0,r.useDispatch)(n.VALIDATION_STORE_KEY);return o&&!o.hidden?(0,s.createElement)("a",{className:"postcode-eu-autofill-intl-bypass-link",onClick:()=>{a(e),t()}},(0,d.__)("Enter an address")):null},h=({addressDetails:e})=>e?.mailLines?(0,s.createElement)("address",{className:"postcode-eu-autofill-address"},e.mailLines.join("\n")):null,f=(0,a.getSetting)("postcode-eu-address-validation_data"),g=({addressType:e,address:t,setAddress:r})=>{const n=(0,o.useRef)(null),[a,d]=(0,o.useState)(null),[c,i]=(0,o.useState)(!1),l=`${e}-intl_autocomplete`;return(0,o.useEffect)((()=>{const t=()=>{const t=document.getElementById(`${e}-address_1`)?.parentElement;return t?.before(n.current),t};if(!t()){const e=new MutationObserver((s=>{s.forEach((()=>{t()&&e.disconnect()}))}));return e.observe(n.current.closest(".wc-block-components-checkout-step__content"),{childList:!0}),()=>e.disconnect()}}),[]),(0,o.useEffect)((()=>{i(Boolean(f.enabledCountries[t.country]))}),[i,t.country]),(0,o.useEffect)((()=>{if("showAll"!==f.displayMode)for(const t of["address_1","postcode","city"]){const s=document.getElementById(`${e}-${t}`)?.parentElement;s&&(s.style.display=c?"none":"")}}),[e,c]),(0,s.createElement)("div",{className:"postcode-eu-autofill-container",ref:n,style:c?{}:{display:"none"}},(0,s.createElement)(m,{id:l,addressType:e,address:t,setAddress:r,setAddressDetails:d}),"showAll"!==f.displayMode&&(0,s.createElement)(E,{forId:l,onClick:()=>{i(!1)}}),(0,s.createElement)(h,{addressDetails:a}))};(0,e.registerCheckoutBlock)({metadata:t,component:()=>{const e=(0,r.useSelect)((e=>e(n.CHECKOUT_STORE_KEY).getUseShippingAsBilling()),[]),{shippingAddress:t}=(0,r.useSelect)((e=>e(n.CART_STORE_KEY).getCustomerData()),[]),{setShippingAddress:a,setBillingAddress:d}=(0,r.useDispatch)(n.CART_STORE_KEY),c=(0,o.useCallback)((t=>{a(t),e&&d({...t})}),[e,a,d]);return(0,s.createElement)(g,{addressType:"shipping",address:t,setAddress:c})}})})();