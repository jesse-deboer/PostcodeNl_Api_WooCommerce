(()=>{"use strict";const e=window.wc.blocksCheckout,t=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"postcode-eu-address-validation/shipping-address-autocomplete-intl","version":"1.0.0","title":"International Address Autocomplete","category":"woocommerce","description":"Autocomplete international addresses using the Postcode.eu API.","example":{},"parent":["woocommerce/checkout-shipping-address-block"],"attributes":{"lock":{"type":"object","default":{"remove":true,"move":true}}},"textdomain":"postcode-eu-address-validation"}'),s=window.React,r=window.wp.data,o=window.wc.wcBlocksData,n=window.wp.element,a=window.wc.wcSettings,d=window.wp.i18n,c=window.wc.blocksComponents;var i,l;const u=(0,a.getSetting)("postcode-eu-address-validation_data"),p=(e,t,s)=>{let r=t,o=s;return u.reverseStreetLineCountries.includes(e)&&([r,o]=[o,r]),`${r} ${o}`.trim()};null!==(l=(i=PostcodeNl).addressDetailsCache)&&void 0!==l||(i.addressDetailsCache=new Map);const m=({id:e,addressType:t,address:a,setAddress:i,setAddressDetails:l})=>{const m=(0,n.useRef)(null),E=(0,n.useRef)(a),h=(0,n.useRef)(""),f=(0,n.useRef)(null),[g,v]=(0,n.useState)(!0),[w,_]=(0,n.useState)(null),[y,A]=(0,n.useState)(!1),[C,D]=(0,n.useState)(""),{setValidationErrors:I,clearValidationError:S}=(0,r.useDispatch)(o.VALIDATION_STORE_KEY),{validationError:b,validationErrorId:k}=(0,r.useSelect)((t=>{const s=t(o.VALIDATION_STORE_KEY);return{validationError:s.getValidationError(e),validationErrorId:s.getValidationErrorId(e)}}));(0,n.useEffect)((()=>{E.current=a}),[a]);const T=(0,n.useCallback)((()=>{i({...E.current,address_1:"",city:"",postcode:""}),l(null)}),[i,l]),R=(0,n.useCallback)(((s=!0)=>{["address_1","city","postcode"].every((e=>void 0===(0,r.select)(o.VALIDATION_STORE_KEY).getValidationError(`${t}_${e}`)))?S(e):I({[e]:{message:(0,d.__)("Please enter an address and select it.","postcode-eu-address-validation"),hidden:s}})}),[e,S,I]),L=(0,n.useCallback)(((e,t)=>{PostcodeNl.addressDetailsCache.has(e)?t(PostcodeNl.addressDetailsCache.get(e)):f.current.getDetails(e,(s=>{t(s),PostcodeNl.addressDetailsCache.set(e,s)}))}),[]),N=(0,n.useCallback)((e=>{_(!0),L(e.context,(e=>{const{locality:t,street:s,postcode:r,building:o}=e.address;i({...E.current,address_1:p(e.country.iso2Code,s,o),city:t,postcode:r}),l(e),R(!1),_(!1)}))}),[_,i,l,R]),O=(0,n.useCallback)((()=>{m.current.addEventListener("autocomplete-response",(e=>{const t=e.detail.matches;1===t.length&&"Address"===t[0].precision?N(t[0]):R(!0)}),{once:!0}),f.current.search(m.current,{term:h.current,showMenu:!1})}),[N,R]);(0,n.useEffect)((()=>{g&&(v(!1),h.current=["postcode","city","address_1","address_2"].map((e=>E.current[e])).join(" ").trim(),D(h.current),m.current.addEventListener("autocomplete-select",(e=>{D(e.detail.value),e.preventDefault(),"Address"===e.detail.precision&&N(e.detail)})),m.current.addEventListener("autocomplete-search",T),m.current.addEventListener("autocomplete-error",(()=>{_(!1),I({[e]:{message:(0,d.__)("An error has occurred while retrieving address data. Please contact us if the problem persists.","postcode-eu-address-validation"),hidden:!1}})})),m.current.addEventListener("autocomplete-open",(()=>A(!0))),m.current.addEventListener("autocomplete-close",(()=>A(!1))))}),[g,v,D,l,T,_,I,A]),(0,n.useEffect)((()=>{var t,s;if(s=a.country,void 0===u.enabledCountries[s])return void S(e);const n=u.enabledCountries[a.country];null===f.current?(f.current=function(e,t){const s=new PostcodeNl.AutocompleteAddress(e,{autocompleteUrl:u.autocomplete,addressDetailsUrl:u.getDetails,context:t});return s.getSuggestions=function(e,t,s){const r=(new TextEncoder).encode(t),o=Array.from(r,(e=>String.fromCodePoint(e))).join(""),n=this.options.autocompleteUrl.replace("${context}",encodeURIComponent(e)).replace("${term}",encodeURIComponent(btoa(o)));return this.xhrGet(`${n}`,s)},s.getDetails=function(e,t){const s=this.options.addressDetailsUrl.replace("${context}",encodeURIComponent(e));return this.xhrGet(s,t)},s}(m.current,n.iso3),h.current.length>0&&O()):(f.current.reset(),f.current.setCountry(n.iso3),T(),D(""));const d=(0,r.select)(o.VALIDATION_STORE_KEY).getValidationError(e);R(null===(t=d?.hidden)||void 0===t||t)}),[a.country,e,S,D,T]),(0,n.useEffect)((()=>()=>S(e)),[S,e]),(0,n.useEffect)((()=>{null!==w&&m.current.classList.toggle(`${f.current.options.cssPrefix}loading`,w)}),[w]);const V=b?.message&&!b?.hidden;return(0,s.createElement)(c.TextInput,{id:e,required:!0,className:{"has-error":V},ref:m,label:(0,d.__)("Start typing your address or zip/postal code","postcode-eu-address-validation"),value:C,onChange:e=>{R(!0),D(e)},onBlur:()=>!y&&R(!1),"aria-invalid":!0===V,ariaDescribedBy:V&&k?k:null,feedback:(0,s.createElement)(c.ValidationInputError,{propertyName:e,elementId:e}),title:""})},E=({forId:e,onClick:t})=>{const n=(0,r.useSelect)((t=>t(o.VALIDATION_STORE_KEY).getValidationError(e))),{clearValidationError:a}=(0,r.useDispatch)(o.VALIDATION_STORE_KEY);return n&&!n.hidden?(0,s.createElement)("a",{className:"postcode-eu-autofill-intl-bypass-link",onClick:()=>{a(e),t()}},(0,d.__)("Enter an address")):null},h=({addressDetails:e})=>e?.mailLines?(0,s.createElement)("address",{className:"postcode-eu-autofill-address"},e.mailLines.join("\n")):null,f=(0,a.getSetting)("postcode-eu-address-validation_data"),g=({addressType:e,address:t,setAddress:r})=>{const o=(0,n.useRef)(null),[a,d]=(0,n.useState)(null),[c,i]=(0,n.useState)(!1),l=`${e}-intl_autocomplete`;return(0,n.useEffect)((()=>{const t=()=>{const t=document.getElementById(`${e}-address_1`)?.parentElement;return t?.before(o.current),t};if(!t()){const e=new MutationObserver((s=>{s.forEach((()=>{t()&&e.disconnect()}))}));return e.observe(o.current.closest(".wc-block-components-checkout-step__content"),{childList:!0}),()=>e.disconnect()}}),[]),(0,n.useEffect)((()=>{i(Boolean(f.enabledCountries[t.country]))}),[i,t.country]),(0,n.useEffect)((()=>{if("showAll"!==f.displayMode)for(const t of["address_1","postcode","city"]){const s=document.getElementById(`${e}-${t}`)?.parentElement;s&&(s.style.display=c?"none":"")}}),[e,c]),(0,s.createElement)("div",{className:"postcode-eu-autofill-container",ref:o,style:c?{}:{display:"none"}},(0,s.createElement)(m,{id:l,addressType:e,address:t,setAddress:r,setAddressDetails:d}),"showAll"!==f.displayMode&&(0,s.createElement)(E,{forId:l,onClick:()=>{i(!1)}}),(0,s.createElement)(h,{addressDetails:a}))};(0,e.registerCheckoutBlock)({metadata:t,component:()=>{const{shippingAddress:e}=(0,r.useSelect)((e=>e(o.CART_STORE_KEY).getCustomerData()),[]),{setShippingAddress:t}=(0,r.useDispatch)(o.CART_STORE_KEY);return(0,s.createElement)(g,{addressType:"shipping",address:e,setAddress:t})}})})();